# Plot Documentation for Phase 2 Pipeline

## Overview
This document describes all plots generated by the phase 2 pipeline, including their data sources, transformations, and specifications.

**Note**: All plot paths are managed by the `PlotPaths` class in `phase2/core/plot_paths.py`, which organizes outputs into metric-based subdirectories for better organization and navigation.

## 1. Cell-level JSD

### a) Snapshot Histogram âœ… EXISTS
**What this plot shows**: For all cells saved at a specific year (like year 30 or year 50), we plot how many cells have each cell-level JSD value. This shows the distribution of cell-level JSD values across all cells in that snapshot.

- **X-axis**: Cell-level JSD value (scalar, range 0-1, continuous)
- **Y-axis**: Count of cells (integer, range 0 to total cells in snapshot)
- **Data Source**: 
  - **Attribute**: `cell.cell_JSD` (single float per cell, range 0-1)
  - **Object**: Each `Cell` object in the snapshot
  - **Location**: `snapshots/year30_snapshot.json` contains a list of cell dictionaries
  - **Output Path**: `results/cell_metrics/distributions/year30_cell_jsd.png`
  - **Computation**: The cell-level JSD was already calculated during the simulation
  - **Transformation**: We read each cell's `cell_JSD` value directly from the JSON
  - **Data structure**: Distribution of scalars - one cell-level JSD value per cell
  - **Example**: If we have 461 cells in the snapshot, we get 461 cell-level JSD values to plot in histogram with 200 bins

### b) Batch Comparison âœ… EXISTS  
**What this plot shows**: For each individual (PetriDish), we calculate the average cell-level JSD across all its cells, then compare these averages between the three batches (mutant, control1, control2). Each dot represents one individual's average.

- **X-axis**: Categorical - three batch labels (Mutant, Control1, Control2)
- **Y-axis**: Mean cell-level JSD per individual (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `cell.cell_JSD` (float) from each cell in the PetriDish
  - **Object**: `PetriDish.cells` (List[Cell])
  - **Location**: `individuals/mutant/individual_XX.json` â†’ `cells` array
  - **Output Path**: `results/cell_metrics/comparisons/cell_jsd_comparison.png`
  - **Transformation**: For each PetriDish, calculate the mean of all cell-level JSD values from its cells
  - **Data structure**: Scalar per individual - we reduce ~156 cell-level JSD values to one mean
  - **Example**: If an individual has 156 cells, we average 156 cell-level JSD values to get one point

### c) Individual Trajectories âœ… EXISTS
**What this plot shows**: For each individual, we track how the average cell-level JSD of its population changes each year from year 30 to year 50. The cell_history stores the complete state of all cells at each year.

- **X-axis**: Time in years (integer, range 30-50, discrete annual steps)
- **Y-axis**: Mean cell-level JSD across all cells (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `cell.cell_JSD` from cells stored in history
  - **Object**: `PetriDish.cell_history` (Dict with year strings as keys)
  - **Location**: `individuals/mutant/individual_XX.json` â†’ `cell_history` dictionary
  - **Transformation**: For each year key, get all cells, extract their cell-level JSD values, calculate mean
  - **Output Paths**: 
    - Mutant: `results/cell_metrics/individual_trajectories/jsd/mutant/individual_XX.png`
    - Control1: `results/cell_metrics/individual_trajectories/jsd/control1/individual_XX.png`
  - **Data structure**: Time series of scalars - one mean value per year for 21 years
  - **Example**: At year "35", if there are 32 cells, we average 32 cell-level JSD values for that point

### d) Original Timeline âœ… EXISTS
**What this plot shows**: The average cell-level JSD across the entire population for each year of the phase 1 simulation, from year 0 to year 50.

- **X-axis**: Time in years (integer, range 0-50, discrete annual steps)
- **Y-axis**: Mean cell-level JSD across all cells (scalar, range 0-1, continuous)
- **Data Source**: Phase1 `simulation.json` â†’ `history` dictionary
- **Output Path**: `results/cell_metrics/timeline/cell_jsd_timeline.png`
- **Transformation**: Same as individual trajectories - for each year, average all cell-level JSD values
- **Data structure**: Time series of scalars - one mean value per year for 51 years

---

## 2. Gene-level JSD

### a) Snapshot Histogram ðŸ†• ADD
**What this plot shows**: We calculate a gene-level JSD value for each of the 20 genes across all cells in the snapshot, then plot how many genes have each gene-level JSD value. Since we only have 20 genes, this histogram will only have 20 data points.

- **X-axis**: Gene-level JSD value (scalar, range 0-1, continuous)
- **Y-axis**: Count of genes (integer, range 0-20)
- **Data Source**:
  - **Attribute**: Not stored - must be calculated using `PetriDish.calculate_gene_jsd()`
  - **Object**: All cells from the snapshot loaded into a PetriDish
  - **Location**: `snapshots/year30_snapshot.json` - load all cells
  - **Output Path**: `results/gene_metrics/distributions/year30_gene_jsd.png`
  - **Computation**: The calculate_gene_jsd() function returns a list of 20 floats, one gene-level JSD per gene
  - **Transformation**: Load snapshot cells â†’ create PetriDish â†’ call calculate_gene_jsd() â†’ get 20 values â†’ plot histogram
  - **Data structure**: Distribution of scalars - one gene-level JSD value per gene (only 20 values total)
  - **Note**: With only 20 values, the histogram bins need to be adjusted (maybe 10 bins instead of 200)

### b) Batch Comparison âœ… EXISTS
**What this plot shows**: For each individual, we average its 20 gene-level JSD values to get one number, then compare these averages between batches.

- **X-axis**: Categorical - three batch labels (Mutant, Control1, Control2)
- **Y-axis**: Mean of the 20 gene-level JSD values per individual (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `metadata['gene_jsds']` - a list of 20 floats stored when the individual was created
  - **Object**: PetriDish metadata dictionary
  - **Location**: `individuals/mutant/individual_XX.json` â†’ `metadata.gene_jsds`
  - **Output Path**: `results/gene_metrics/comparisons/gene_jsd_comparison.png`
  - **Transformation**: Take the mean of the 20 gene-level JSD values to get one point per individual
  - **Data structure**: Scalar per individual - we reduce 20 gene-level JSD values to one mean

### c) Individual Trajectories ðŸ†• ADD
**What this plot shows**: For each year in an individual's history, we calculate the 20 gene-level JSD values for that year's cell population, then plot both the mean and median of those 20 values over time.

- **X-axis**: Time in years (integer, range 30-50, discrete annual steps)
- **Y-axis**: Two lines - Mean and Median of the 20 gene-level JSD values (scalars, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: Must calculate from cells' methylated arrays at each timepoint
  - **Object**: `PetriDish.cell_history` dictionary
  - **Location**: `individuals/mutant/individual_XX.json` â†’ `cell_history`
  - **Computation**: For each year, load the cells, create a PetriDish, call calculate_gene_jsd() to get 20 values
  - **Output Paths**:
    - Mutant: `results/gene_metrics/individual_trajectories/mutant/individual_XX.png`
    - Control1: `results/gene_metrics/individual_trajectories/control1/individual_XX.png`
  - **Transformation**: 
    1. For year "35": get cells from cell_history["35"]
    2. Create PetriDish with those cells
    3. Call calculate_gene_jsd() â†’ get 20 gene-level JSD values
    4. Calculate mean and median of those 20 values
    5. Plot both values for that year
  - **Data structure**: Two time series of scalars - one mean and one median per year for 21 years

### d) Original Timeline ðŸ†• ADD
**What this plot shows**: Same as individual trajectories but for the entire phase 1 simulation - the mean and median of 20 gene-level JSD values at each year from 0 to 50.

- **X-axis**: Time in years (integer, range 0-50, discrete annual steps)
- **Y-axis**: Two lines - Mean and Median of the 20 gene-level JSD values (scalars, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: Either `gene_jsd_history` if it was saved, or calculate from `history`
  - **Object**: Simulation data from phase 1
  - **Transformation**: If gene_jsd_history exists, use those values directly. Otherwise, same calculation as individual trajectories
  - **Data structure**: Two time series of scalars - one mean and one median per year for 51 years

---

## 3. Cell Methylation Proportion

### a) Snapshot Histogram ðŸ†• ADD
**What this plot shows**: For all cells in a snapshot, we calculate what fraction of each cell's sites are methylated (e.g., 30 out of 100 = 0.30), then plot how many cells have each methylation proportion.

- **X-axis**: Cell methylation proportion (scalar, range 0-1, continuous)
- **Y-axis**: Count of cells (integer, range 0 to total cells in snapshot)
- **Data Source**:
  - **Attribute**: `cell.methylated` - a list of 0s and 1s, one for each CpG site
  - **Object**: Each Cell in the snapshot
  - **Location**: `snapshots/year30_snapshot.json` â†’ each cell's `cpg_sites` array (or `methylated` in legacy files)
  - **Output Path**: `results/cell_metrics/distributions/year30_cell_methylation_proportion.png`
  - **Computation**: Count the 1s in the methylated array, divide by array length
  - **Transformation**: For each cell: `proportion = sum(cpg_sites) / len(cpg_sites)`
  - **Data structure**: Distribution of scalars - one methylation proportion per cell
  - **Example**: If a cell has [0,1,1,0,1...] with 47 ones out of 100 sites â†’ proportion = 0.47
  - **Expected ranges**: Year 30 cells will cluster around 0.25-0.35, Year 50 cells around 0.45-0.55

### b) Batch Comparison ðŸ†• ADD
**What this plot shows**: For each individual, we calculate the average cell methylation proportion across all its cells, then compare these averages between batches.

- **Output Path**: `results/cell_metrics/comparisons/cell_methylation_proportion_comparison.png`

- **X-axis**: Categorical - three batch labels (Mutant, Control1, Control2)
- **Y-axis**: Mean methylation proportion per individual (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `cell.methylated` arrays from each cell
  - **Object**: `PetriDish.cells` list
  - **Location**: `individuals/mutant/individual_XX.json` â†’ `cells` â†’ each cell's `methylated`
  - **Computation**: For each cell, calculate its methylation proportion, then average across all cells
  - **Transformation**: 
    1. For each cell: calculate sum(methylated)/len(methylated)
    2. Average all these proportions to get one value per individual
  - **Data structure**: Scalar per individual - we reduce ~156 methylation proportions to one mean

### c) Individual Trajectories âœ… EXISTS
**What this plot shows**: For each individual, we track how the average methylation proportion changes from year 30 to year 50.

- **X-axis**: Time in years (integer, range 30-50, discrete annual steps)
- **Y-axis**: Mean methylation proportion (scalar, range 0-1, continuous)
- **Data structure**: Time series of scalars - one mean value per year for 21 years
- **Already implemented**

### d) Original Timeline âœ… EXISTS
**What this plot shows**: The average methylation proportion across all cells for each year of the phase 1 simulation.

- **X-axis**: Time in years (integer, range 0-50, discrete annual steps)
- **Y-axis**: Mean methylation proportion (scalar, range 0-1, continuous)
- **Data structure**: Time series of scalars - one mean value per year for 51 years
- **Already implemented**

---

## Summary Matrix

| Metric | Snapshot Histogram | Batch Comparison | Individual Trajectories | Original Timeline |
|--------|-------------------|------------------|------------------------|-------------------|
| **Cell-level JSD** | âœ… Exists | âœ… Exists | âœ… Exists | âœ… Exists |
| **Gene-level JSD** | ðŸ†• Add (20 points) | âœ… Exists | ðŸ†• Add (mean+median) | ðŸ†• Add (mean+median) |
| **Cell Methylation** | ðŸ†• Add | ðŸ†• Add | âœ… Exists | âœ… Exists |

## New Plots to Implement (5 total)

1. **Gene-level JSD Snapshot Histogram** 
   - Distribution plot with only 20 data points (one gene-level JSD per gene)
   - X: gene-level JSD value, Y: count of genes

2. **Gene-level JSD Individual Trajectories** 
   - Time series with two lines (mean and median of 20 gene-level JSD values)
   - X: years 30-50, Y: mean/median gene-level JSD

3. **Gene-level JSD Original Timeline** 
   - Time series with two lines (mean and median of 20 gene-level JSD values)
   - X: years 0-50, Y: mean/median gene-level JSD

4. **Cell Methylation Snapshot Histogram** 
   - Distribution plot of methylation proportions across all cells
   - X: methylation proportion, Y: count of cells

5. **Cell Methylation Batch Comparison** 
   - Categorical comparison of mean methylation per individual
   - X: batch labels, Y: mean methylation proportion