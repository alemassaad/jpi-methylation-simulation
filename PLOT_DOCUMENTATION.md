# Plot Documentation for Phase 2 Pipeline

## Overview
This document describes all plots generated by the phase 2 pipeline, including their data sources, transformations, and specifications.

**Note**: All plot paths are managed by the `PlotPaths` class in `phase2/core/plot_paths.py`, which organizes outputs into metric-based subdirectories for better organization and navigation.

**Update (September 2025)**: Gene-level JSD trajectory plots have been significantly improved to match the professional styling of cell-level plots, now including percentile bands, dual axes, and comprehensive statistics.

## Color Scheme Convention
Plots use consistent coloring based on metric type:
- **JSD plots**: Blue (#1f77b4) histogram/line with red mean line
- **Methylation plots**: Red (#d62728) histogram/line with dark blue mean line
- **Batch groups**: Control (green #2ca02c), Test 1 (orange #ff7f0e), Test 2 (blue #1f77b4)

## 1. Cell-level JSD

### a) Snapshot Histogram ✅ EXISTS
**What this plot shows**: For all cells saved at a specific year (like year 30 or year 50), we plot how many cells have each cell-level JSD value. This shows the distribution of cell-level JSD values across all cells in that snapshot.

- **X-axis**: Cell-level JSD value (scalar, range 0-1, continuous)
- **Y-axis**: Count of cells (integer, range 0 to total cells in snapshot)
- **Visualization**: Blue step plot with fill, red vertical mean line, comprehensive statistics box
- **Data Source**: 
  - **Attribute**: `cell.cell_JSD` (single float per cell, range 0-1)
  - **Object**: Each `Cell` object in the snapshot
  - **Location**: `snapshots/year30_snapshot.json` contains a list of cell dictionaries
  - **Output Path**: `results/cell_metrics/distributions/year30_cell_jsd.png`
  - **Computation**: The cell-level JSD was already calculated during the simulation
  - **Transformation**: We read each cell's `cell_JSD` value directly from the JSON
  - **Data structure**: Distribution of scalars - one cell-level JSD value per cell
  - **Example**: If we have 461 cells in the snapshot, we get 461 cell-level JSD values to plot in histogram with 200 bins

### b) Batch Comparison ✅ EXISTS
**What this plot shows**: For each individual (PetriDish), we calculate the average cell-level JSD across all its cells, then compare these averages between the three batches (test2, test1, control). Each dot represents one individual's average.

- **X-axis**: Categorical - three batch labels (Control, Test 1, Test 2)
- **Y-axis**: Mean cell-level JSD per individual (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `cell.cell_JSD` (float) from each cell in the PetriDish
  - **Object**: `PetriDish.cells` (List[Cell])
  - **Location**: `individuals/test2/individual_XX.json` → `cells` array
  - **Output Path**: `results/cell_metrics/comparisons/cell_jsd_comparison.png`
  - **Transformation**: For each PetriDish, calculate the mean of all cell-level JSD values from its cells
  - **Data structure**: Scalar per individual - we reduce ~156 cell-level JSD values to one mean
  - **Example**: If an individual has 156 cells, we average 156 cell-level JSD values to get one point

### c) Individual Trajectories ✅ EXISTS
**What this plot shows**: For each individual, we track how the average cell-level JSD of its population changes each year from year 30 to year 50. The cell_history stores the complete state of all cells at each year.

- **X-axis**: Time in years (integer, range 30-50, discrete annual steps)
- **Y-axis**: Mean cell-level JSD across all cells (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `cell.cell_JSD` from cells stored in history
  - **Object**: `PetriDish.cell_history` (Dict with year strings as keys)
  - **Location**: `individuals/test2/individual_XX.json` → `cell_history` dictionary
  - **Transformation**: For each year key, get all cells, extract their cell-level JSD values, calculate mean
  - **Output Paths**: 
    - Test 2: `results/cell_metrics/individual_trajectories/jsd/test2/individual_XX.png`
    - Test 1: `results/cell_metrics/individual_trajectories/jsd/test1/individual_XX.png`
  - **Data structure**: Time series of scalars - one mean value per year for 21 years
  - **Example**: At year "35", if there are 32 cells, we average 32 cell-level JSD values for that point

### d) Original Timeline ✅ EXISTS
**What this plot shows**: The average cell-level JSD across the entire population for each year of the phase 1 simulation, from year 0 to year 50.

- **X-axis**: Time in years (integer, range 0-50, discrete annual steps)
- **Y-axis**: Mean cell-level JSD across all cells (scalar, range 0-1, continuous)
- **Data Source**: Phase1 `simulation.json` → `history` dictionary
- **Output Path**: `results/cell_metrics/timeline/cell_jsd_timeline.png`
- **Transformation**: Same as individual trajectories - for each year, average all cell-level JSD values
- **Data structure**: Time series of scalars - one mean value per year for 51 years

---

## 2. Gene-level JSD

### a) Snapshot Histogram ❌ REMOVED
**This plot was removed**: The gene_jsd_snapshot_comparison plot has been removed from the pipeline as it was not providing useful insights with only 20 data points.

### b) Batch Comparison ✅ EXISTS  
**What this plot shows**: For each individual, we average its 20 gene-level JSD values to get one number, then compare these averages between batches.

- **X-axis**: Categorical - three batch labels (Control, Test 1, Test 2)
- **Y-axis**: Mean of the 20 gene-level JSD values per individual (scalar, range 0-1, continuous)
- **Visualization**: Scatter plot with jitter, batch colors (blue/orange/green), quantile lines
- **Data Source**:
  - **Attribute**: `metadata['gene_jsds']` - a list of 20 floats stored when the individual was created
  - **Object**: PetriDish metadata dictionary
  - **Location**: `individuals/test2/individual_XX.json` → `metadata.gene_jsds`
  - **Output Path**: `results/gene_metrics/comparisons/gene_jsd_comparison.png`
  - **Transformation**: Take the mean of the 20 gene-level JSD values to get one point per individual
  - **Data structure**: Scalar per individual - we reduce 20 gene-level JSD values to one mean

### c) Individual Trajectories ✅ EXISTS (IMPROVED Sept 2025)
**What this plot shows**: For each year in an individual's history, we calculate the 20 gene-level JSD values for that year's cell population, then plot the distribution of those values with percentile bands, mean, and median over time.

- **X-axis**: Time in years (integer, range 30-50, discrete annual steps)
- **Y-axis (Primary)**: Gene JSD Score (range 0-1, continuous)
- **Y-axis (Secondary)**: Cell Count (integer, population size)
- **Visualization**: Professional multi-layer plot with:
  - **Blue percentile bands**: 5-95% (light blue) and 25-75% (darker blue) showing spread across 20 genes
  - **Blue solid line**: Mean of the 20 gene-level JSD values
  - **Orange dashed line**: Median of the 20 gene-level JSD values
  - **Orange dotted line**: Cell count on secondary y-axis
  - **Gray dashed vertical line**: Growth phase indicator
  - **Statistics box**: Final year statistics including mean, median, and percentile ranges
- **Data Source**:
  - **Attribute**: Must calculate from cells' methylated arrays at each timepoint
  - **Object**: `PetriDish.cell_history` dictionary
  - **Location**: `individuals/test2/individual_XX.json` → `cell_history`
  - **Function**: `PetriDishPlotter.plot_gene_jsd_trajectory()` in `phase1/cell.py`
  - **Output Paths**:
    - Test 2: `results/gene_metrics/individual_trajectories/test2/individual_XX.png`
    - Test 1: `results/gene_metrics/individual_trajectories/test1/individual_XX.png`
  - **Transformation**: 
    1. For year "35": get cells from cell_history["35"]
    2. Create PetriDish with those cells
    3. Call calculate_gene_jsd() → get 20 gene-level JSD values
    4. Calculate mean, median, and percentiles (5, 25, 75, 95) of those 20 values
    5. Track population size for secondary axis
    6. Plot with percentile bands and dual axes
  - **Data structure**: Time series with statistics - mean, median, and percentiles per year for 21 years

### d) Original Timeline ✅ EXISTS (IMPROVED Sept 2025)
**What this plot shows**: Same as individual trajectories but for the entire phase 1 simulation - shows the distribution of 20 gene-level JSD values at each year from 0 to 50 with percentile bands.

- **X-axis**: Time in years (integer, range 0-50, discrete annual steps)
- **Y-axis (Primary)**: Gene JSD Score (range 0-1, continuous)
- **Y-axis (Secondary)**: Cell Count (integer, population size)
- **Visualization**: Identical style to individual trajectories with percentile bands, dual axes, and statistics
- **Data Source**:
  - **Attribute**: Either `gene_jsd_history` if it was saved, or calculate from `history`
  - **Object**: Simulation data from phase 1
  - **Function**: `PetriDishPlotter.plot_gene_jsd_timeline()` in `phase1/cell.py`
  - **Transformation**: If gene_jsd_history exists, use those values directly. Otherwise, same calculation as individual trajectories with percentiles
  - **Data structure**: Two time series of scalars - one mean and one median per year for 51 years

---

## 3. Cell Methylation Proportion

### a) Snapshot Histogram ✅ EXISTS
**What this plot shows**: For all cells in a snapshot, we calculate what fraction of each cell's sites are methylated (e.g., 30 out of 100 = 0.30), then plot how many cells have each methylation proportion.

- **X-axis**: Cell methylation proportion (scalar, range 0-1, continuous)
- **Y-axis**: Count of cells (integer, range 0 to total cells in snapshot)
- **Visualization**: Red step plot with fill, dark blue vertical mean line, comprehensive statistics box
- **Data Source**:
  - **Attribute**: `cell.methylated` - a list of 0s and 1s, one for each CpG site
  - **Object**: Each Cell in the snapshot
  - **Location**: `snapshots/year30_snapshot.json` → each cell's `cpg_sites` array (or `methylated` in legacy files)
  - **Output Path**: `results/cell_metrics/distributions/year30_cell_methylation_proportion.png`
  - **Computation**: Count the 1s in the methylated array, divide by array length
  - **Transformation**: For each cell: `proportion = sum(cpg_sites) / len(cpg_sites)`
  - **Data structure**: Distribution of scalars - one methylation proportion per cell
  - **Example**: If a cell has [0,1,1,0,1...] with 47 ones out of 100 sites → proportion = 0.47
  - **Expected ranges**: Year 30 cells will cluster around 0.25-0.35, Year 50 cells around 0.45-0.55

### b) Batch Comparison ✅ EXISTS
**What this plot shows**: For each individual, we calculate the average cell methylation proportion across all its cells, then compare these averages between batches.

- **Output Path**: `results/cell_metrics/comparisons/cell_methylation_proportion_comparison.png`

- **X-axis**: Categorical - three batch labels (Control, Test 1, Test 2)
- **Y-axis**: Mean methylation proportion per individual (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `cell.methylated` arrays from each cell
  - **Object**: `PetriDish.cells` list
  - **Location**: `individuals/test2/individual_XX.json` → `cells` → each cell's `methylated`
  - **Computation**: For each cell, calculate its methylation proportion, then average across all cells
  - **Transformation**: 
    1. For each cell: calculate sum(methylated)/len(methylated)
    2. Average all these proportions to get one value per individual
  - **Data structure**: Scalar per individual - we reduce ~156 methylation proportions to one mean

### c) Individual Trajectories ✅ EXISTS
**What this plot shows**: For each individual, we track how the average methylation proportion changes from year 30 to year 50.

- **X-axis**: Time in years (integer, range 30-50, discrete annual steps)
- **Y-axis**: Mean methylation proportion (scalar, range 0-1, continuous)
- **Data structure**: Time series of scalars - one mean value per year for 21 years
- **Already implemented**

### d) Original Timeline ✅ EXISTS
**What this plot shows**: The average methylation proportion across all cells for each year of the phase 1 simulation.

- **X-axis**: Time in years (integer, range 0-50, discrete annual steps)
- **Y-axis**: Mean methylation proportion (scalar, range 0-1, continuous)
- **Data structure**: Time series of scalars - one mean value per year for 51 years
- **Already implemented**

---

## 4. Gene Methylation Proportion

### a) Snapshot Histogram ✅ EXISTS
**What this plot shows**: Distribution of gene methylation proportions across 20 genes at a specific snapshot year.

- **X-axis**: Gene methylation proportion (scalar, range 0-1, continuous)
- **Y-axis**: Count of genes (integer, max 20)
- **Data Source**: 
  - **Attribute**: `petri.gene_methylation_proportions` property
  - **Object**: PetriDish created from snapshot cells
  - **Location**: Calculated from cells in `snapshots/year30_snapshot.json`
  - **Output Path**: `results/gene_metrics/distributions/year30_gene_methylation.png`
  - **Computation**: Average methylation proportion for each gene across all cells
  - **Transformation**: For each gene, sum methylation across all cells, divide by (num_cells × gene_size)
- **Data structure**: 20 values, one per gene
- **Visualization**: Step plot with fill, red mean line, comprehensive statistics (CV, MAD, percentiles)

### b) Batch Comparison ✅ EXISTS
**What this plot shows**: For each individual, we calculate the average gene methylation proportion across all 20 genes, then compare these averages between batches.

- **X-axis**: Categorical - three batch labels (Control, Test 1, Test 2)
- **Y-axis**: Mean gene methylation proportion per individual (scalar, range 0-1, continuous)
- **Data Source**:
  - **Attribute**: `metadata['gene_mean_methylation']` - a list of 20 proportions
  - **Object**: PetriDish metadata dictionary
  - **Location**: `individuals/test2/individual_XX.json` → `metadata.gene_mean_methylation`
  - **Output Path**: `results/gene_metrics/comparisons/gene_methylation_comparison.png`
  - **Transformation**: Take the mean of the 20 gene methylation proportions to get one point per individual
  - **Data structure**: Scalar per individual - we reduce 20 gene methylation values to one mean

### c) Individual Trajectories ✅ EXISTS  
**What this plot shows**: For each individual, tracks the mean and median of gene methylation proportions across 20 genes over time.

- **X-axis**: Time in years (integer, range 30-50, discrete annual steps)
- **Y-axis**: Two lines - Mean and Median of the 20 gene methylation proportions
- **Output Paths**:
  - Mutant: `results/gene_metrics/individual_trajectories/test2/individual_XX_methylation.png`
  - Control1: `results/gene_metrics/individual_trajectories/test1/individual_XX_methylation.png`

### d) Original Timeline ✅ EXISTS
**What this plot shows**: The mean and median of gene methylation proportions for the entire phase 1 simulation.

- **X-axis**: Time in years (integer, range 0-50, discrete annual steps)
- **Y-axis**: Two lines - Mean and Median of the 20 gene methylation proportions
- **Output Path**: `results/gene_metrics/timeline/gene_methylation_timeline.png`

---

## Summary Matrix

| Metric | Snapshot Histogram | Batch Comparison | Individual Trajectories | Original Timeline |
|--------|-------------------|------------------|------------------------|-------------------|
| **Cell-level JSD** | ✅ Exists | ✅ Exists | ✅ Exists | ✅ Exists |
| **Gene-level JSD** | ❌ Removed | ✅ Exists | ✅ Exists | ✅ Exists |
| **Cell Methylation** | ✅ Exists | ✅ Exists | ✅ Exists | ✅ Exists |
| **Gene Methylation** | ✅ Exists | ✅ Exists | ✅ Exists | ✅ Exists |

## Current Implementation Status

All plots have been implemented! The only exception:
1. **Gene-level JSD Snapshot Histogram** - Removed as not useful with only 20 data points (would just show 20 genes distributed across JSD values)

## Implementation Details

### Distribution Plots
All distribution plots use identical implementation:
- **Step plots** with filled area (not bar histograms)
- **Mean line** with contrasting color (red for blue plots, dark blue for red plots)
- **Statistics box** in top-right with: Mean, Median, SD, CV, MAD, 5%, 95%
- **Functions**: 
  - `plot_cell_jsd_distribution()` - 200 bins
  - `plot_gene_jsd_distribution()` - 20 bins
  - `plot_cell_methylation_proportion_histogram()` - 200 bins  
  - `plot_gene_methylation_proportion_histogram()` - 20 bins

### OOP Access Pattern
Clean property-based access for all metrics:
- **Cell level**: `cell.cell_jsd`, `cell.cpg_sites` (for methylation)
- **Gene level**: `petri.gene_jsds`, `petri.gene_methylation_proportions`
- No temporary objects or complex calculations in plotting functions

## Technical Notes

### Dictionary Key Convention
**IMPORTANT**: All history dictionaries in the codebase use **string keys** for years to ensure JSON compatibility:
- `cell_history`, `gene_jsd_history`, `mean_gene_jsd_history`, `median_gene_jsd_history` all use string keys
- When sorting years, use pattern: `years = sorted([int(y) for y in history.keys()])`
- When accessing, convert back: `history[str(year)]`
- This convention prevents type comparison errors and ensures JSON serialization works correctly

## JSON Output Files

### Analysis Results
- **`cell_jsd_analysis.json`**: Cell-level JSD statistics and individual means
- **`gene_jsd_analysis.json`**: Gene-level JSD distributions and individual averages
- **`gene_methylation_analysis.json`**: Gene methylation proportion statistics
- **`pipeline_metadata.json`**: Pipeline parameters and configuration
- **`mixing_statistics.json`**: Mixing statistics (only with --uniform-mixing flag)